<% layout("/layouts/boilerplate") -%>

<!--
  USER DASHBOARD PAGE

  Purpose:
  This page displays personalized data for the logged-in user.

  Data comes from controller like:
  res.render("dashboard", {
      currUser,
      myListings,
      myBookings,
      wishlist
  });

  MVC Flow:
  Controller → Pass data → EJS renders dynamic content
-->

<div class="container mt-5">
  <div class="row">

    <!-- ================= SIDEBAR ================= -->
    <!-- Used to switch between different dashboard sections -->
    <div class="col-md-3 mb-4">
      <div class="list-group shadow-sm">

        <!-- Switch to My Listings -->
        <a class="list-group-item list-group-item-action"
           href="#listings"
           onclick="showSection('listingsSection')">
          <i class="fa-solid fa-house-user me-2"></i> My Listings
        </a>

        <!-- Switch to My Bookings -->
        <a class="list-group-item list-group-item-action"
           href="#bookings"
           onclick="showSection('bookingsSection')">
          <i class="fa-solid fa-calendar-check me-2"></i> My Bookings
        </a>

        <!-- Switch to My Wishlist -->
        <a class="list-group-item list-group-item-action"
           href="#wishlist"
           onclick="showSection('wishlistSection')">
          <i class="fa-solid fa-heart me-2"></i> My Wishlist
        </a>

        <!-- Logout Route -->
        <a class="list-group-item list-group-item-action text-danger"
           href="/logout">
          <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
        </a>

      </div>
    </div>


    <!-- ================= MAIN CONTENT ================= -->
    <div class="col-md-9">

      <!-- Display logged-in user's username -->
      <h2>Welcome, <%= currUser.username %> </h2>
      <hr/>

      <!-- ================= MY LISTINGS SECTION ================= -->
      <div id="listingsSection" class="dashboard-section">

        <h3>My Listings</h3>

        <!-- If user has no listings -->
        <% if (myListings.length === 0) { %>
          <p>You haven't created any listings yet.</p>
        <% } else { %>

          <!-- Loop through user's listings -->
          <div class="row">
            <% myListings.forEach(listing => { %>

              <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">

                  <!-- Listing Image -->
                  <img src="<%= listing.image.url %>"
                       class="card-img-top"
                       alt="Listing image">

                  <div class="card-body">

                    <!-- Listing Title -->
                    <h5 class="card-title"><%= listing.title %></h5>

                    <!-- View Listing -->
                    <a href="/listings/<%= listing._id %>"
                       class="btn btn-sm btn-outline-primary">
                       View
                    </a>

                  </div>
                </div>
              </div>

            <% }) %>
          </div>

        <% } %>
      </div>


      <!-- ================= MY BOOKINGS SECTION ================= -->
      <div id="bookingsSection"
           class="dashboard-section"
           style="display:none;">

        <h3>My Bookings</h3>

        <% if (myBookings.length === 0) { %>
          <p>You haven’t booked any listings.</p>
        <% } else { %>

          <ul class="list-group">

            <% myBookings.forEach(booking => { %>
              <li class="list-group-item">

                <!-- Booking Listing Title -->
                <strong>
                  <%= booking.listing ? booking.listing.title : "Listing Not Available" %>
                </strong>

                <!-- Booking Dates -->
                —
                From <%= booking.checkIn ? booking.checkIn.toDateString() : "Unknown" %>
                to <%= booking.checkOut ? booking.checkOut.toDateString() : "Unknown" %>

                <!-- Cancel Booking -->
                <form action="/bookings/<%= booking._id %>/cancel?_method=DELETE"
                      method="POST">

                  <button class="btn btn-danger btn-sm">
                    Cancel
                  </button>
                </form>

              </li>
            <% }) %>

          </ul>

        <% } %>
      </div>


      <!-- ================= MY WISHLIST SECTION ================= -->
      <div id="wishlistSection"
           class="dashboard-section"
           style="display:none;">

        <h3>My Wishlist</h3>

        <% if (wishlist.length === 0) { %>
          <p>No listings in wishlist.</p>
        <% } else { %>

          <div class="row">

            <% wishlist.forEach(listing => { %>

              <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">

                  <!-- Wishlist Listing Image -->
                  <img src="<%= listing.image.url %>"
                       class="card-img-top"
                       alt="Wishlist image">

                  <div class="card-body">

                    <!-- Wishlist Title -->
                    <h6 class="card-title"><%= listing.title %></h6>

                    <!-- View Listing -->
                    <a href="/listings/<%= listing._id %>"
                       class="btn btn-sm btn-outline-dark">
                       View
                    </a>

                    <!-- Remove from Wishlist -->
                    <form action="/wishlist/<%= listing._id %>/remove"
                          method="POST"
                          class="d-inline">

                      <button class="btn btn-sm btn-outline-danger">
                        Remove
                      </button>
                    </form>

                  </div>
                </div>
              </div>

            <% }) %>

          </div>

        <% } %>
      </div>

    </div>
  </div>
</div>


<!-- ================= SECTION SWITCH SCRIPT ================= -->
<script>
  /*
    This function switches between dashboard sections
    without reloading the page.
  */

  function showSection(sectionId) {

    // Select all dashboard sections
    const sections = document.querySelectorAll('.dashboard-section');

    // Hide all sections
    sections.forEach(sec => sec.style.display = 'none');

    // Show selected section
    document.getElementById(sectionId).style.display = 'block';
  }

  // Optional: Show section based on URL hash
  const hash = window.location.hash.replace('#', '');

  if (hash) {
    showSection(hash + 'Section');
  } else {
    showSection('listingsSection');
  }
</script>


<!-- ================= STYLING SECTION ================= -->
<style>
  /* Background styling */
  body {
    background-color: #f9f9f9;
  }

  /* Animation for section switching */
  .dashboard-section {
    animation: fadeIn 0.4s ease-in;
  }

  /* Sidebar styling */
  .list-group-item {
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
  }

  .list-group-item:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
  }

  .list-group-item-action.text-danger:hover {
    background-color: #ffe6e6;
  }

  /* Card styling */
  .card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    transition: box-shadow 0.3s ease-in-out;
  }

  .card:hover {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  .card-img-top {
    height: 200px;
    object-fit: cover;
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .btn-outline-primary,
  .btn-outline-dark,
  .btn-outline-danger {
    border-radius: 20px;
  }

  h2, h3 {
    font-weight: bold;
    color: #333;
  }
</style>