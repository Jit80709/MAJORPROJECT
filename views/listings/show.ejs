<% layout("/layouts/boilerplate") -%>

<style>
.star-rating {
  direction: rtl;
  display: inline-flex;
}
.star-rating input { display: none; }
.star-rating label {
  font-size: 30px;
  color: #ccc;
  cursor: pointer;
}
.star-rating input:checked ~ label { color: #ffc107; }

#map {
  height: 400px;
  width: 100%;
  border-radius: 12px;
}
</style>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const coordinates = <%- JSON.stringify(listing.geometry.coordinates) %>;
  window.bookedRanges = <%- JSON.stringify(bookedRanges || []) %>;
</script>

<div class="row mt-3">

  <!-- TITLE -->
  <div class="col-8 offset-3">
    <h3>
      <%= listing.title %>

      <% if (avgRating && listing.reviews.length > 0) { %>
        <span class="text-warning fs-5 ms-2">
          ⭐ <%= avgRating %>
        </span>
        <small class="text-muted">
          (<%= listing.reviews.length %> reviews)
        </small>
      <% } %>
    </h3>
  </div>


  <!-- LISTING CARD -->
  <div class="card col-6 offset-3 listing-card">
    <img src="<%= listing.image.url %>" class="card-img-top"/>

    <div class="card-body">

      <p><i>Owned by <%= listing.owner?.username %></i></p>
      <p><%= listing.description %></p>

      <p class="fw-bold fs-5">
        ₹ <%= listing.price.toLocaleString("en-IN") %> / night
      </p>

      <p><%= listing.location %>, <%= listing.country %></p>

      <!-- OWNER CONTROLS -->
      <% if (
        currUser &&
        listing.owner &&
        listing.owner._id.toString() === currUser._id.toString()
      ) { %>

        <hr/>

        <a href="/listings/<%= listing._id %>/edit"
           class="btn btn-dark">
          Edit
        </a>

        <form method="POST"
              action="/listings/<%= listing._id %>?_method=DELETE"
              class="d-inline">
          <button class="btn btn-danger">
            Delete
          </button>
        </form>

      <% } %>


      <!-- USER BOOKING -->
      <% if (
        currUser &&
        listing.owner &&
        listing.owner._id.toString() !== currUser._id.toString()
      ) { %>

        <hr/>

        <form action="/bookings" method="POST">

          <input type="hidden"
                 name="listingId"
                 value="<%= listing._id %>">

          <div class="mb-2">
            <label>Check In</label>
            <input type="text"
                   id="checkIn"
                   name="checkIn"
                   class="form-control"
                   required>
          </div>

          <div class="mb-2">
            <label>Check Out</label>
            <input type="text"
                   id="checkOut"
                   name="checkOut"
                   class="form-control"
                   required>
          </div>

          <button type="submit"
                  class="btn btn-success w-100 mt-2">
            Confirm Booking
          </button>

        </form>

      <% } %>

    </div>
  </div>


  <!-- REVIEW SECTION -->
  <div class="col-8 offset-3 mt-4">

    <% if (currUser) { %>

      <h4>Leave a Review</h4>

      <form action="/listings/<%= listing._id %>/reviews"
            method="POST">

        <div class="star-rating mb-2">
          <input type="radio" id="star5" name="review[rating]" value="5" required>
          <label for="star5">★</label>
          <input type="radio" id="star4" name="review[rating]" value="4">
          <label for="star4">★</label>
          <input type="radio" id="star3" name="review[rating]" value="3">
          <label for="star3">★</label>
          <input type="radio" id="star2" name="review[rating]" value="2">
          <label for="star2">★</label>
          <input type="radio" id="star1" name="review[rating]" value="1">
          <label for="star1">★</label>
        </div>

        <textarea name="review[comment]"
                  rows="3"
                  class="form-control"
                  required></textarea>

        <button class="btn btn-outline-dark mt-2">
          Submit
        </button>

      </form>

    <% } %>


    <!-- SHOW REVIEWS -->
    <% for (review of listing.reviews) { %>

      <div class="card mt-3">
        <div class="card-body">
          <h6>@<%= review.author?.username %></h6>
          <p class="text-warning">⭐ <%= review.rating %></p>
          <p><%= review.comment %></p>

          <% if (
            currUser &&
            review.author &&
            review.author._id.toString() === currUser._id.toString()
          ) { %>

            <form method="POST"
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-dark">
                Delete
              </button>
            </form>

          <% } %>

        </div>
      </div>

    <% } %>

  </div>


  <!-- MAP -->
  <div class="col-6 offset-3 mt-4">
    <h3>Where you'll be</h3>
    <div id="map"></div>
  </div>

</div>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script defer src="/js/calendar.js"></script>

<!-- Mapbox -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<script>
  mapboxgl.accessToken = mapToken;
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: coordinates,
    zoom: 9
  });
  new mapboxgl.Marker().setLngLat(coordinates).addTo(map);
</script>